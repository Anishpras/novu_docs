---
title: 'Clerk'
pageTitle: 'Novu and Clerk integration guide'
description: 'This guide walks you through integrating Clerk webhooks with Novu notifications in a Next.js application.'
---

You'll learn how to automatically trigger notification workflows when **any Clerk event** occurs, such as **user creation, email events, or password changes**.

## Overview

When specific events happen in Clerk (e.g., user signup, password changes, email verification), this integration will:

1. Receive the webhook event from Clerk.
2. Verify the webhook signature.
3. Process the event data.
4. Trigger the corresponding **Novu notification workflow**.

<Callout>
You can also clone this repository: https://github.com/iampearceman/clerk-webhook-novu
</Callout>

## Prerequisites

Before proceeding, ensure you have:

- A **Clerk + Next.js app** ([Set up Clerk](https://clerk.com/docs/quickstarts/nextjs)).
- A **ngrok account** ([Sign up here](https://dashboard.ngrok.com/signup)).
- A **Novu account** ([Sign up here](https://novu.com/signup)).

## **Step 1: Install Dependencies**

Run the following command to install the required packages:

```
npm install svix @novu/api @clerk/nextjs
```

---

## **Step 2: Configure Environment Variables**

Add the following variables to yourÂ `.env.local`Â file:

```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
CLERK_SECRET_KEY=sk_test_...
CLERK_SIGNING_SECRET=whsec_...
NOVU_SECRET_KEY=novu_secret_...
```

---

## **Step 3: Expose Your Local Server**

To test webhooks locally, you need to expose your **local server** to the internet.

There are two common options:

### **Using LocalTunnel (Quick & Free)**

LocalTunnel is a simple and free way to expose your local server without requiring an account.

1. Start a localtunnel listener

   ```
   npx localtunnel 3000
   ```

2. Copy and save the generated **public URL** (e.g., `https://your-localtunnel-url.loca.lt`).

<Callout>
LocalTunnel links may expire quickly and sometimes face reliability issues.
</Callout>

### **Using ngrok (More Reliable & Secure)**

For a more stable and configurable tunnel, use **ngrok**:

1. Create an account at [ngrok dashboard](https://dashboard.ngrok.com/).
2. Follow the [setup guide](https://dashboard.ngrok.com/get-started/setup).
3. Run the command:

   ```
   ngrok http 3000
   ```

4. Copy and save the **Forwarding URL** (e.g., `https://your-ngrok-url.ngrok.io`).

> ðŸ›  **Why ngrok?** Ngrok provides more control, persistent subdomains (with a paid plan), and additional security options.

---

## **Step 4: Set Up Clerk Webhook Endpoint**

1. Go to theÂ **Clerk Webhooks**Â page ([link](https://dashboard.clerk.com/last-active?path=webhooks)).
2. ClickÂ **Add Endpoint**.
3. Set theÂ **Endpoint URL**Â as:

   ```
      https://your-forwarding-URL/api/webhooks/clerk
   ```

4. Subscribe to theÂ **relevant Clerk events**Â (e.g.,Â `user.created`,Â `email.created`Â etc.).
5. ClickÂ **Create**Â and keep the settings page open.

---

## **Step 5: Add Signing Secret to Environment Variables**

1. Copy theÂ **Signing Secret**Â from Clerk'sÂ **Webhook Endpoint Settings**.
2. Add it to yourÂ `.env.local`Â file:

```
CLERK_SIGNING_SECRET=your_signing_secret_here
```

---

## **Step 6: Make Webhook Route Public**

Ensure the webhook route is public by updatingÂ `middleware.ts`Â :

```jsx
import { clerkMiddleware } from '@clerk/nextjs/server';

export default clerkMiddleware({
  publicRoutes: ['/api/webhooks'],
});
```

---

## **Step 7: Create Webhook Endpoint for Clerk in Next.js**

CreateÂ `app/api/webhooks/clerk/route.ts`Â :

```jsx
import { Webhook } from 'svix'
import { headers } from 'next/headers'
import { WebhookEvent } from '@clerk/nextjs/server'
import { triggerWorkflow } from '../../notifications/route'

export async function POST(request: Request) {
    try {
        const SIGNING_SECRET = process.env.SIGNING_SECRET
        if (!SIGNING_SECRET) {
            throw new Error('Please add SIGNING_SECRET from Clerk Dashboard to .env')
        }

        const webhook = new Webhook(SIGNING_SECRET)
        const headerPayload = await headers()
        const validatedHeaders = validateHeaders(headerPayload)

        const payload = await request.json()
        const body = JSON.stringify(payload)

        const event = await verifyWebhook(webhook, body, {
            'svix-id': validatedHeaders.svix_id,
            'svix-timestamp': validatedHeaders.svix_timestamp,
            'svix-signature': validatedHeaders.svix_signature,
        })

        await handleWebhookEvent(event)

        return new Response('Webhook received', { status: 200 })
    } catch (error) {
        console.error('Webhook processing error:', error)
        return new Response(`Error: ${error instanceof Error ? error.message : 'Unknown error'}`, { status: 400 })
    }
}

const handleWebhookEvent = async (event: WebhookEvent) => {
    if (event.type !== "user.created" && event.type !== "email.created") {
        return
    }

    const workflow = await workflowBuilder(event)
    const subscriber = await subscriberBuilder(event)
    const payload = await payloadBuilder(event)

    console.log("Triggering workflow:", workflow, "Subscriber:", subscriber, "Payload:", payload)
    await triggerWorkflow(workflow, subscriber, payload)
}

async function workflowBuilder(event: WebhookEvent) {
    let workflow = "";
    if (event.type === "user.created") {
        workflow = "user-created";
    } else if (event.type === "email.created") {
        workflow = `${event.data.slug?.replace(/_/g, '-') || ''}`;
    }
    return workflow;
}

async function subscriberBuilder(response: any) {

    // Rely only on webhook event data
    const webhookData = response.data;

    // Get the user from Clerk (Optional)
    // const user = await clerkClient.users.getUser(data.id);

    // Build the subscriber data
    return {
        subscriberId: webhookData.id, // Required field
        firstName: webhookData.first_name || '',
        lastName: webhookData.last_name || '',
        email: webhookData.email_addresses[0]?.email_address || '',
        phone: webhookData.phone_numbers?.[0]?.phone_number || '',
        locale: 'en_US', // Default locale
        avatar: webhookData.image_url || '',
        data: {
            username: webhookData.username || '',
            clerkUserId: webhookData.id || '',
        },
    }
}

async function payloadBuilder(response: any) {
    const webhookData = JSON.parse(response);
    return webhookData;
}

const validateHeaders = (headerPayload: Headers) => {
    const svix_id = headerPayload.get('svix-id')
    const svix_timestamp = headerPayload.get('svix-timestamp')
    const svix_signature = headerPayload.get('svix-signature')

    if (!svix_id || !svix_timestamp || !svix_signature) {
        throw new Error('Missing Svix headers')
    }

    return { svix_id, svix_timestamp, svix_signature }
}

const verifyWebhook = async (webhook: Webhook, body: string, headers: any): Promise<WebhookEvent> => {
    try {
        return webhook.verify(body, headers) as WebhookEvent
    } catch (err) {
        console.error('Error: Could not verify webhook:', err)
        throw new Error('Verification error')
    }
}
```

---

## **Step 8: Add Novu Workflow Notification Trigger Function**

CreateÂ `app/api/notifications/route.ts`Â :

```jsx
import { Novu } from '@novu/api';
const novu = new Novu({
    secretKey: process.env['NOVU_SECRET_KEY']
});

export async function triggerWorkflow(workflowId: string, subscriber: object, payload: object) {
    try {
        await novu.trigger({
            workflowId,
            to: subscriber,
            payload
        });
        return new Response('Notification triggered', { status: 200 });
    } catch (error) {
        return new Response('Error triggering notification', { status: 500 });
    }
}
```

---

## **Step 9: Add or create Novu workflows in your Novu dashboard**

Each workflow should be triggered by a specific event.

For example, you can create a workflow to trigger when a user is created.

---

## Step 10: Disable Email **Delivered by Clerk**

By default, Clerk sends email notifications whenever necessary, such as Magic Links for email verification, Invitations, Password Resets, and more.

To prevent users from receiving duplicate emails, we need to disable email delivery by Clerk for the notifications handled by Novu.

1. Navigate to the **Emails** section in the Clerk Dashboard.

   ![Clerk's Dashboard 1](/images/guides/clerk/clerk-email-dashboard.png)

2. Select any **email.created** event that you want Novu to handle.
3. Toggle **off** email delivery for the selected event.

   ![Clerk's Dashboard 2](/images/guides/clerk/clerk-email-dashboard2.png)

This ensures that Clerk does not send duplicate emails, allowing Novu to manage the notifications seamlessly.

---

## **Step 11: Test the Webhook**

1. Start your Next.js server.
2. Go toÂ **Clerk Webhooks â†’ Testing**.
3. Select an event (e.g.,Â `user.created`,Â `email.created`).
4. ClickÂ **Send Example**.
5. Verify logs inÂ **your terminal**.

---

You've successfully integrated Clerk webhooks with Novu to automate notifications for **any Clerk event**. Now, every time a **user is created, an email is sent, or a password is changed**, Novu will send notifications automatically!
